## Overview
MONAI Deploy End to End tests are designed to test the ingestion of DICOM data using the [MONAI Informatics Gateway](https://github.com/Project-MONAI/monai-deploy-informatics-gateway) and the orchestration of clinical workflows and AI models using the [MONAI Workflow Manager](https://github.com/Project-MONAI/monai-deploy-workflow-manager).

They are designed to think about how these MONAI components will be used in production and cover real life scenarios. Automated Integration tests have been added to these projects and are detailed under [MIG Integration Tests](https://github.com/Project-MONAI/monai-deploy-informatics-gateway/tree/develop/tests/Integration.Test) and [MWM Integration Tests](https://github.com/Project-MONAI/monai-deploy-workflow-manager/tree/develop/tests/IntegrationTests)

## Purpose
This document describes the test coverage, test data, status of their execution and details of the environment.

## Test Scenarios
The below matrix was created to replicate and test real life scenarios.

| ID              | Category               | Test Description                                                                   | Summary                                                                                                                                                                                           | Dicom Study | Clinical Workflow Ref                           | Argo Workflow                                | Status                                 |
| --------------- | ---------------------- | ---------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ----------------------------------------------- | -------------------------------------------- | -------------------------------------- |
| MONAI\_E2E\_001 | workflow\_management   | Create and trigger workflow                                                        | Create and trigger a workflow by sending DICOM data to MIG.                                                                                                                                       | Study\_1    | argo\_workflow.json                             | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_002 | workflow\_management   | Update workflow and trigger latest revision                                        | Update a workflow and trigger by sending data to MIG.                                                                                                                                             | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_003 | workflow\_management   | Deletion workflow and send data to MIG                                             | Delete a workflow and send data which would have triggered workflow.                                                                                                                              | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_2                            | Passed                                 |
| MONAI\_E2E\_004 | argo                   | Execution of a workflow (CT)                                                       | Workflow is triggered and report is exported to PACS.                                                                                                                                             | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_005 | argo                   | Execution of a workflow (MR)                                                       | Workflow is triggered and report is exported to PACS.                                                                                                                                             | Study\_3    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_006 | argo                   | Execution of a workflow (US)                                                       | Workflow is triggered and report is exported to PACS.                                                                                                                                             | Study\_4    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_007 | argo                   | Execution of a workflow (Xray)                                                     | Workflow is triggered and report is exported to PACS.                                                                                                                                             | Study\_5    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_008 | argo                   | Execution of a workflow for a multi-series study                                   | Multi-series study is sent through as one association which results in a single report back to PACS.                                                                                              | Study\_6    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_009 | argo\_gpu              | Execution of a workflow where the Argo task requires GPU                           | Workflow is triggered with a model which required GPU access.                                                                                                                                     | Study\_1    | liver-seg.json                                  | argo\_workflow\_5                            | Not Yet Run                            |
| MONAI\_E2E\_010 | argo\_map              | Execution of a workflow where the Argo task uses a MAP                             | Workflow is triggered with a model which is created as a MAP.                                                                                                                                     | Study\_1    | argo\_map\_workflow.json                        | argo\_workflow\_5                            | Not Yet Run                            |
| MONAI\_E2E\_011 | workflow\_execution    | No execution when there isnt a match on a workflow AETitle                         | No workflows are triggered when a workflow request does not match on AETitle.                                                                                                                     | Study\_3    | alt\_aetitle.json                               | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_012 | router                 | Router task filters out execution based on DICOM modality                          | Router task filters out payloads which should not be executed on.                                                                                                                                 | Study\_1    | router\_workflow\_1.json                        | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_013 | router                 | Router task forwards to correct Task Destination                                   | Router task directs study down the MR branch of the workflow                                                                                                                                      | Study\_3    | router\_workflow\_1.json                        | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_014 | router                 | Router task forwards to correct Task Destination                                   | Router task directs study down the US branch of the workflow                                                                                                                                      | Study\_4    | router\_workflow\_1.json                        | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_015 | conditional\_execution | Combination of DICOM tags determine the execution                                  | Router task directs study down path when conditional statement returns 'True'                                                                                                                     | Study\_1    | router\_workflow\_3.json                        | argo\_worflow\_1                             | Passed                                 |
| MONAI\_E2E\_016 | conditional\_execution | Combination of DICOM tags determine the execution                                  | Router task stops directs study down path when conditional statement returns 'False'                                                                                                              | Study\_2    | router\_workflow\_3.json                        | argo\_worflow\_1                             | Passed                                 |
| MONAI\_E2E\_017 | task\_destinations     | Argo tasks can chain                                                               | A task can specify what the next task to run is by using Task Destinations. Both reports are exported using a single Export task                                                                  | Study\_1    | task\_destination.json                          | argo\_workflow\_1 and argo\_workflow\_1\_new | Passed                                 |
| MONAI\_E2E\_018 | task\_destinations     | Argo task chaining with conditions but second task doesnt execute                  | Workflow has 2 Argo tasks that chain, however the conditions on the first task taskDestination means that the second argo task doesnt execute.                                                    | Study\_1    | task\_destination\_conditions.json              | argo\_workflow\_1 (for both)                 | Passed                                 |
| MONAI\_E2E\_019 | task\_destinations     | Argo task chaining with conditions and second task does execute                    | Workflow has 2 Argo tasks that chain and the conditions are true meaning the second Argo Task executes                                                                                            | Study\_2    | task\_destination\_conditions.json              | argo\_workflow\_1 (for both)                 | Passed                                 |
| MONAI\_E2E\_020 | input\_artefacts       | Mandatory Artefact passes between Argo Tasks                                       | Workflow has 2 Argo tasks that chain. The mandatory input of the second Task is an output artefact from the first.                                                                                | Study\_3    | input\_artefacts\_mandatory\_exists.json        | argo\_workflow\_2<br>argo\_workflow\_3       | Passed                                 |
| MONAI\_E2E\_021 | input\_artefacts       | Non Mandatory Artefact passes between Argo Tasks                                   | Workflow has 2 Argo tasks that chain. The non-mandatory input of the second being the output from the first.                                                                                      | Study\_3    | input\_artefacts\_non\_mandatory\_exists.json   | argo\_workflow\_2<br>argo\_workflow\_3       | Passed                                 |
| MONAI\_E2E\_022 | input\_artefacts       | Mandatory Artefact missing causes an exception                                     | Workflow has 2 Argo tasks that chain. The mandatory input of the second being something that does not exist. This will cause the WorkflowExecutor to mark that Task as failed and not dispatch it | Study\_3    | input\_artefacts\_mandatory\_missing.json       | argo\_workflow\_2<br>argo\_workflow\_3       | Passed                                 |
| MONAI\_E2E\_023 | input\_artefacts       | Non Mandatory Artefact missing means that task is still dispatched                 | Workflow has 2 Argo tasks that chain. The non-mandatory input of the second being something that does not exist but second Task is still dispatched                                               | Study\_3    | input\_artefacts\_non\_mandatory\_missing.json  | argo\_workflow\_2<br>argo\_workflow\_3       | Passed                                 |
| MONAI\_E2E\_024 | input\_artefacts       | Non Mandatory Artefact missing causes an exception. Workflow misconfiguration      | Workflow has 2 Argo tasks that chain. The non-mandatory input of the second being something that does not exist but second Task requires it. Task is dispatched but throws an exception.          | Study\_3    | input\_artefacts\_non\_mandatory\_missing.json  | argo\_workflow\_2 (for both)                 | N/A Covered as part of MONAI\_E2E\_022 |
| MONAI\_E2E\_025 | output\_artefacts      | Mandatory output artefact is missing                                               | Workflow has a mandatory output artefact specified which is not generated. This causes the Task to be marked as Failed                                                                            | Study\_1    | output\_artefacts\_mandatory\_missing.json      | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_026 | output\_artefacts      | Non Mandatory output artefact is missing                                           | Workflow has a non mandatory output artefact specified which is not generated. Workflow completes without issue.                                                                                  | Study\_1    | output\_artefacts\_non\_mandatory\_missing.json | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_027 | export                 | Files within folder are exported                                                   | Export Task will export a folder back to PACS                                                                                                                                                     | Study\_3    | export\_folder.json                             | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_028 | task\_failed           | Model execution throws exception                                                   | Workfow references argo\_workflow\_exception which will thrown a known exception. This marks the workflow as failed.                                                                              | Study\_1    | model\_exception\_workflow.json                 | argo\_workflow\_exception                    | Passed                                 |
| MONAI\_E2E\_029 | task\_failed           | Model exceeds timeout and task is marked as Cancelled                              | Workfow references an argo task which runs longer than is specified in the clincial workflow timeout.                                                                                             | Study\_1    | timeout\_exception\_workflow.json               | argo\_workflow\_sleep                        | Fail                                   |
| MONAI\_E2E\_030 | parallel\_execution    | Parellel execution of seperate Argo tasks                                          | Workflow has a router task that triggers two argo tasks in parallel. This is to replicate 2 models within the same workflow executing on the same input                                           | Study\_1    | router\_workflow\_2.json                        | argo-workflow-sleep-a                        | Passed                                 |
| MONAI\_E2E\_031 | parallel\_execution    | Parellel execution of a workflow by sending multiple different studies             | Trigger workflow multiple times by sending 5 studies in quick succession. Execution should not be linear and containers are created on demand.                                                    | Study\_1    | argo\_workflow\_long\_running.json              | argo-workflow-sleep-a                        | Passed                                 |
| MONAI\_E2E\_032 | resiliency             | MinIO is not online for initial input via MIG                                      | MinIO is offline/disconnected. argo\_workflow\_1 is executed and will retry a configurable number of times. MinIO is reconnected in this time and the workflow completes.                         | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Not Yet Run                            |
| MONAI\_E2E\_033 | resiliency             | MinIO is not online for saving results back from an Argo Task                      | MinIO is offline/disconnected. argo\_workflow\_1 is executed and will retry a configurable number of times. MinIO is reconnected in this time and the workflow completes.                         | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_2                            | Not Yet Run                            |
| MONAI\_E2E\_034 | resiliency             | Mongo is not online. After timeout model execution fails                           | Mongo is offline/disconnected. argo\_workflow\_1 is executed and will retry a configurable number of times. Mongo is not reconnected in this time and the workflow fails.                         | Study\_3    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_035 | resiliency             | Mongo is not online. Mongo reconnected before timeout and model execution succeeds | Mongo is offline/disconnected. argo\_workflow\_1 is executed and will retry a configurable number of times. Mongo is reconnected in this time and the workflow succeeds.                          | Study\_3    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_036 | resiliency             | Rabbit is not online. Model execution fails and payload is lost                    | Rabbit is offline/disconnected. A payload is sent. Payload is not sent after retries fail.                                                                                                        | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Passed                                 |
| MONAI\_E2E\_037 | resiliency             | MIG is not online and attempt to send data from PACS                               | PACS cannot send data to MIG and association fails                                                                                                                                                | Study\_3    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Not Yet Run                            |
| MONAI\_E2E\_038 | resiliency             | MWM is not online and send data from PACS                                          | WorkflowRequestEvent sits on the queue until the Workflow Manager comes back online.                                                                                                              | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_1                            | Not Yet Run                            |
| MONAI\_E2E\_039 | resiliency             | PACS is down and try to export results from MIG                                    | PACS is down which causes the export request to fail                                                                                                                                              | Study\_1    | argo\_export\_workflow.json                     | argo\_workflow\_2                            | Not Yet Run                            |
| MONAI\_E2E\_040 | task\_failed           | Clinical workflow references a Argo Workflow Template that does not exist.         | Argo workflow does not exist which causes the Task and Workflow to fail                                                                                                                           | any         | no\_argo\_exists.json                           | n/a                                          | Not Yet Run                            |

### Creating additional Test Coverage
If additional tests are required please ensure:
1. [test-scenarios](/e2e-testing/test-scenarios) spread sheet is updated
2. Corresponding [test-data](/e2e-testing/) to be added
3. Matrix above updated

### Applications
TBC

### Test Data
The [test-data](/e2e-testing/test-data) folder contains all the tests data to support the execution of the End to End tests. This includes Argo workflows Clinical Workflows and DICOM studies used.

#### Argo Workflows
| Name                      | Description                                                                                                                                                          |
| ------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| argo\_workflow\_1         | Both operators of the mean pixel calc (test\_operator & test\_reporter) can be executed as a single Argo Task                                                        |
| argo\_workflow\_2         | test\_operator of the mean pixel calc can be executed in isolation as a single Argo Task                                                                             |
| argo\_workflow\_3         | reporter\_operator of the mean pixel calc can be executed in isolation as a single Argo Task                                                                         |
| argo\_workflow\_exception | Both operators of the mean pixel calc (test\_operator & test\_reporter) can be executed as a single Argo Task. Image used for test\_operator will throw an exception |
| argo\_workflow\_4         | Both operators of the mean pixel calc (test\_operator & test\_reporter) can be executed as a single Argo Task. Hard coded [thread.sl](http://thread.sl/)eep(5 mins)  |
| argo\_workflow\_5         | Argo Task with GPU enabled                                                                                                                                           |
| argo\_workflow\_6         | Argo Task with MAP

#### DICOM Studies
| Name     | Description    |
| -------- | -------------- |
| Study\_1 | CT Head Study  |
| Study\_2 | CT Chest Study |
| Study\_3 | MR Study       |
| Study\_4 | US Study       |
| Study\_5 | Xray Study     |
| Study\_6 | Multi-series   |

### Deployment
TBC

## Examples
The [examples](/e2e-testing/examples) folder contains examples of Clinical and Argo workflows for 2 MAPs ([Liver-Seg](./examples/liver-seg) and [Lung-Seg](./examples/lung-seg)). Currently these sit as separate Clinical workflows with the same AET but can be combined into 1 Clinical Workflow using a Router Task.
